name: Test Check RETCODE Action

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Tipo de prueba a ejecutar'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - valid_cases
          - invalid_cases
          - edge_cases

  push:
    branches:
      - "feature/check-retcode"

jobs:
  # Job para probar casos válidos
  test-valid-configurations:
    name: "✅ Pruebas de Configuraciones Válidas"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test_case:
          - name: "Configuración completa"
            retcode: "5"
            expected_status: "failure"
            should_fail: true
          - name: "Código de éxito"
            retcode: "0"
            expected_status: "success"
            should_fail: false
          - name: "Advertencia"
            retcode: "4"
            expected_status: "warning"
            should_fail: false
          - name: "Advertencia con fail_on_warning=true"
            retcode: "4"
            expected_status: "warning"
            should_fail: true
            fail_on_warning: "true"
          - name: "Código en rango"
            retcode: "7"
            expected_status: "severe"
            should_fail: true
          - name: "Código crítico"
            retcode: "9"
            expected_status: "critical"
            should_fail: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Crear configuración válida
        run: |
          cat > codes.json << 'EOF'
          {
            "version": "1.0",
            "description": "Configuración de códigos de retorno para compilación",
            "codes": [
              {
                "range": "0-3",
                "status": "success",
                "title": "Éxito",
                "message": "Compilación exitosa.",
                "should_fail": false
              },
              {
                "range": "4",
                "status": "warning",
                "title": "Alerta",
                "message": "Compilación exitosa con advertencia: límite de respuesta próximo a alcanzarse.",
                "should_fail": false
              },
              {
                "range": "5",
                "status": "failure",
                "title": "Fallo",
                "message": "Compilación fallida: límite de código excedido. Se requiere revisión.",
                "should_fail": true
              },
              {
                "range": "6-8",
                "status": "severe",
                "title": "Fallo",
                "message": "Compilación fallida por error severo. Revisión inmediata recomendada.",
                "should_fail": true
              },
              {
                "range": "9",
                "status": "critical",
                "title": "Fallo Crítico",
                "message": "Compilación fallida por error crítico. Ejecución detenida.",
                "should_fail": true
              }
            ],
            "fallback": {
              "status": "critical",
              "title": "Código Desconocido",
              "message": "Código de retorno inesperado ({code}). Revisar configuración de rangos.",
              "should_fail": true
            }
          }
          EOF

      - name: "Probar: ${{ matrix.test_case.name }}"
        id: test
        uses: ./.github/actions/check-retcode
        with:
          retcode: ${{ matrix.test_case.retcode }}
          config_file: codes.json
          fail_on_warning: ${{ matrix.test_case.fail_on_warning || 'false' }}
        continue-on-error: true

      - name: Validar resultado
        run: |
          echo "=== Resultado de la prueba ==="
          echo "Caso: ${{ matrix.test_case.name }}"
          echo "Código probado: ${{ matrix.test_case.retcode }}"
          echo "Status esperado: ${{ matrix.test_case.expected_status }}"
          echo "Status obtenido: ${{ steps.test.outputs.status }}"
          echo "Should fail esperado: ${{ matrix.test_case.should_fail }}"
          echo "Should fail obtenido: ${{ steps.test.outputs.should_fail }}"
          echo "Mensaje: ${{ steps.test.outputs.message }}"
          
          # Validar status
          if [[ "${{ steps.test.outputs.status }}" != "${{ matrix.test_case.expected_status }}" ]]; then
            echo "❌ ERROR: Status no coincide"
            exit 1
          fi
          
          # Validar should_fail
          if [[ "${{ steps.test.outputs.should_fail }}" != "${{ matrix.test_case.should_fail }}" ]]; then
            echo "❌ ERROR: should_fail no coincide"
            exit 1
          fi
          
          echo "✅ Prueba exitosa"

  # Job para probar casos inválidos
  test-invalid-configurations:
    name: "❌ Pruebas de Configuraciones Inválidas"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test_case:
          - name: "JSON vacío"
            json: "{}"
          - name: "Sin array codes"
            json: '{"fallback": {"status": "critical", "title": "Error", "message": "Error", "should_fail": true}}'
          - name: "Array codes vacío"
            json: '{"codes": [], "fallback": {"status": "critical", "title": "Error", "message": "Error", "should_fail": true}}'
          - name: "Sin fallback"
            json: '{"codes": [{"range": "0", "status": "success", "title": "OK", "message": "OK", "should_fail": false}]}'
          - name: "Código sin campo obligatorio"
            json: '{"codes": [{"range": "0", "status": "success", "title": "OK"}], "fallback": {"status": "critical", "title": "Error", "message": "Error", "should_fail": true}}'
          - name: "Fallback sin campo obligatorio"
            json: '{"codes": [{"range": "0", "status": "success", "title": "OK", "message": "OK", "should_fail": false}], "fallback": {"status": "critical", "title": "Error"}}'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "Crear JSON inválido: ${{ matrix.test_case.name }}"
        run: |
          echo '${{ matrix.test_case.json }}' > codes.json
          echo "JSON creado:"
          cat codes.json

      - name: "Probar configuración inválida: ${{ matrix.test_case.name }}"
        id: test
        uses: ./.github/actions/check-retcode
        with:
          retcode: "0"
          config_file: codes.json
        continue-on-error: true

      - name: Validar que falló correctamente
        run: |
          echo "=== Validando fallo esperado ==="
          echo "Caso: ${{ matrix.test_case.name }}"
          echo "Exit code del step: ${{ steps.test.outcome }}"
          
          if [[ "${{ steps.test.outcome }}" != "failure" ]]; then
            echo "❌ ERROR: Se esperaba que fallara pero no falló"
            echo "Status: ${{ steps.test.outputs.status }}"
            echo "Message: ${{ steps.test.outputs.message }}"
            exit 1
          fi
          
          echo "✅ Falló correctamente como se esperaba"