name: Test Check RETCODE Action

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Tipo de prueba a ejecutar'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - valid_cases
          - invalid_cases
          - edge_cases

  push:
    branches:
      - "feature/check-retcode"

jobs:
  # Job para probar casos vÃ¡lidos
  test-valid-configurations:
    name: "âœ… Pruebas de Configuraciones VÃ¡lidas"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test_case:
          - name: "ConfiguraciÃ³n completa"
            retcode: "5"
            expected_status: "failure"
            should_fail: true
          - name: "CÃ³digo de Ã©xito"
            retcode: "0"
            expected_status: "success"
            should_fail: false
          - name: "Advertencia"
            retcode: "4"
            expected_status: "warning"
            should_fail: false
          - name: "Advertencia con fail_on_warning=true"
            retcode: "4"
            expected_status: "warning"
            should_fail: true
            fail_on_warning: "true"
          - name: "CÃ³digo en rango"
            retcode: "7"
            expected_status: "severe"
            should_fail: true
          - name: "CÃ³digo crÃ­tico"
            retcode: "9"
            expected_status: "critical"
            should_fail: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Crear configuraciÃ³n vÃ¡lida
        run: |
          cat > codes.json << 'EOF'
          {
            "version": "1.0",
            "description": "ConfiguraciÃ³n de cÃ³digos de retorno para compilaciÃ³n",
            "codes": [
              {
                "range": "0-3",
                "status": "success",
                "title": "Ã‰xito",
                "message": "CompilaciÃ³n exitosa (cÃ³digo {code}).",
                "should_fail": false
              },
              {
                "range": "4",
                "status": "warning",
                "title": "Alerta",
                "message": "CompilaciÃ³n exitosa con advertencia: lÃ­mite de respuesta prÃ³ximo a alcanzarse (cÃ³digo {code}).",
                "should_fail": false
              },
              {
                "range": "5",
                "status": "failure",
                "title": "Fallo",
                "message": "CompilaciÃ³n fallida: lÃ­mite de cÃ³digo excedido. Se requiere revisiÃ³n (cÃ³digo {code}).",
                "should_fail": true
              },
              {
                "range": "6-8",
                "status": "severe",
                "title": "Fallo",
                "message": "CompilaciÃ³n fallida por error severo. RevisiÃ³n inmediata recomendada (cÃ³digo {code}).",
                "should_fail": true
              },
              {
                "range": "9",
                "status": "critical",
                "title": "Fallo CrÃ­tico",
                "message": "CompilaciÃ³n fallida por error crÃ­tico. EjecuciÃ³n detenida (cÃ³digo {code}).",
                "should_fail": true
              }
            ],
            "fallback": {
              "status": "critical",
              "title": "CÃ³digo Desconocido",
              "message": "CÃ³digo de retorno inesperado ({code}). Revisar configuraciÃ³n de rangos.",
              "should_fail": true
            }
          }
          EOF

      - name: "Probar: ${{ matrix.test_case.name }}"
        id: test
        uses: ./.github/actions/check-retcode
        with:
          retcode: ${{ matrix.test_case.retcode }}
          config_file: codes.json
          fail_on_warning: ${{ matrix.test_case.fail_on_warning || 'false' }}
        continue-on-error: true

      - name: Validar resultado
        run: |
          echo "=== Resultado de la prueba ==="
          echo "Caso: ${{ matrix.test_case.name }}"
          echo "CÃ³digo probado: ${{ matrix.test_case.retcode }}"
          echo "Status esperado: ${{ matrix.test_case.expected_status }}"
          echo "Status obtenido: ${{ steps.test.outputs.status }}"
          echo "Should fail esperado: ${{ matrix.test_case.should_fail }}"
          echo "Should fail obtenido: ${{ steps.test.outputs.should_fail }}"
          echo "Mensaje: ${{ steps.test.outputs.message }}"
          
          # Validar status
          if [[ "${{ steps.test.outputs.status }}" != "${{ matrix.test_case.expected_status }}" ]]; then
            echo "âŒ ERROR: Status no coincide"
            exit 1
          fi
          
          # Validar should_fail
          if [[ "${{ steps.test.outputs.should_fail }}" != "${{ matrix.test_case.should_fail }}" ]]; then
            echo "âŒ ERROR: should_fail no coincide"
            exit 1
          fi
          
          # Validar que el placeholder {code} fue reemplazado
          if [[ "${{ steps.test.outputs.message }}" == *"{code}"* ]]; then
            echo "âŒ ERROR: Placeholder {code} no fue reemplazado"
            exit 1
          fi
          
          echo "âœ… Prueba exitosa"

  # Job para probar casos invÃ¡lidos
  test-invalid-configurations:
    name: "âŒ Pruebas de Configuraciones InvÃ¡lidas"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test_case:
          - name: "JSON vacÃ­o"
            json: "{}"
          - name: "Sin array codes"
            json: '{"fallback": {"status": "critical", "title": "Error", "message": "Error", "should_fail": true}}'
          - name: "Array codes vacÃ­o"
            json: '{"codes": [], "fallback": {"status": "critical", "title": "Error", "message": "Error", "should_fail": true}}'
          - name: "Sin fallback"
            json: '{"codes": [{"range": "0", "status": "success", "title": "OK", "message": "OK", "should_fail": false}]}'
          - name: "CÃ³digo sin campo obligatorio"
            json: '{"codes": [{"range": "0", "status": "success", "title": "OK"}], "fallback": {"status": "critical", "title": "Error", "message": "Error", "should_fail": true}}'
          - name: "Fallback sin campo obligatorio"
            json: '{"codes": [{"range": "0", "status": "success", "title": "OK", "message": "OK", "should_fail": false}], "fallback": {"status": "critical", "title": "Error"}}'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: "Crear JSON invÃ¡lido: ${{ matrix.test_case.name }}"
        run: |
          echo '${{ matrix.test_case.json }}' > codes.json
          echo "JSON creado:"
          cat codes.json

      - name: "Probar configuraciÃ³n invÃ¡lida: ${{ matrix.test_case.name }}"
        id: test
        uses: ./.github/actions/check-retcode
        with:
          retcode: "0"
          config_file: codes.json
        continue-on-error: true

      - name: Validar que fallÃ³ correctamente
        run: |
          echo "=== Validando fallo esperado ==="
          echo "Caso: ${{ matrix.test_case.name }}"
          echo "Exit code del step: ${{ steps.test.outcome }}"
          
          if [[ "${{ steps.test.outcome }}" != "failure" ]]; then
            echo "âŒ ERROR: Se esperaba que fallara pero no fallÃ³"
            echo "Status: ${{ steps.test.outputs.status }}"
            echo "Message: ${{ steps.test.outputs.message }}"
            exit 1
          fi
          
          echo "âœ… FallÃ³ correctamente como se esperaba"



  # Job para probar casos edge
  test-edge-cases:
    name: "ðŸŽ¯ Pruebas de Casos Edge"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test_case:
          - name: "CÃ³digo con ceros a la izquierda"
            retcode: "007"
            expected_code: "7"
          - name: "CÃ³digo fallback"
            retcode: "999"
            expected_status: "critical"
          - name: "CÃ³digo en lÃ­mite inferior de rango"
            retcode: "6"
            expected_status: "severe"
          - name: "CÃ³digo en lÃ­mite superior de rango"
            retcode: "8"
            expected_status: "severe"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Crear configuraciÃ³n para edge cases
        run: |
          cat > codes.json << 'EOF'
          {
            "codes": [
              {
                "range": "0-3",
                "status": "success",
                "title": "Ã‰xito",
                "message": "CompilaciÃ³n exitosa (cÃ³digo {code}).",
                "should_fail": false
              },
              {
                "range": "6-8",
                "status": "severe",
                "title": "Fallo Severo",
                "message": "Error severo con cÃ³digo {code}.",
                "should_fail": true
              }
            ],
            "fallback": {
              "status": "critical",
              "title": "CÃ³digo Desconocido",
              "message": "CÃ³digo inesperado: {code}",
              "should_fail": true
            }
          }
          EOF

      - name: "Probar edge case: ${{ matrix.test_case.name }}"
        id: test
        uses: ./.github/actions/check-retcode
        with:
          retcode: ${{ matrix.test_case.retcode }}
          config_file: codes.json
        continue-on-error: true

      - name: Validar resultado del edge case
        run: |
          echo "=== Edge Case Results ==="
          echo "Caso: ${{ matrix.test_case.name }}"
          echo "CÃ³digo enviado: ${{ matrix.test_case.retcode }}"
          echo "Status obtenido: ${{ steps.test.outputs.status }}"
          echo "Mensaje: ${{ steps.test.outputs.message }}"
          
          # Para caso de cÃ³digo fallback
          if [[ "${{ matrix.test_case.name }}" == *"fallback"* ]]; then
            if [[ "${{ steps.test.outputs.status }}" != "${{ matrix.test_case.expected_status }}" ]]; then
              echo "âŒ ERROR: Status fallback no coincide"
              exit 1
            fi
          fi
          
          # Para caso de ceros a la izquierda
          if [[ "${{ matrix.test_case.name }}" == *"ceros"* ]]; then
            if [[ "${{ steps.test.outputs.message }}" != *"${{ matrix.test_case.expected_code }}"* ]]; then
              echo "âŒ ERROR: El cÃ³digo no se procesÃ³ correctamente (ceros a la izquierda)"
              exit 1
            fi
          fi
          
          # Para casos de lÃ­mites de rango
          if [[ "${{ matrix.test_case.name }}" == *"lÃ­mite"* ]]; then
            if [[ "${{ steps.test.outputs.status }}" != "${{ matrix.test_case.expected_status }}" ]]; then
              echo "âŒ ERROR: Status en lÃ­mite de rango no coincide"
              exit 1
            fi
          fi
          
          echo "âœ… Edge case pasÃ³ correctamente"

  # Job final de resumen
  test-summary:
    name: "ðŸ“‹ Resumen de Pruebas"
    runs-on: ubuntu-latest
    needs: [test-valid-configurations, test-invalid-configurations, test-edge-cases]
    if: always()
    steps:
      - name: Resumen de resultados
        run: |
          echo "# ðŸ“Š Resumen de Pruebas JSON Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Resultados por categorÃ­a:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Configuraciones vÃ¡lidas
          if [[ "${{ needs.test-valid-configurations.result }}" == "success" ]]; then
            echo "âœ… **Configuraciones VÃ¡lidas**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Configuraciones VÃ¡lidas**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Configuraciones invÃ¡lidas
          if [[ "${{ needs.test-invalid-configurations.result }}" == "success" ]]; then
            echo "âœ… **Configuraciones InvÃ¡lidas**: PASSED (correctamente rechazadas)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Configuraciones InvÃ¡lidas**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Edge cases
          if [[ "${{ needs.test-edge-cases.result }}" == "success" ]]; then
            echo "âœ… **Casos Edge**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Casos Edge**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Estado general:" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.test-valid-configurations.result }}" == "success" && \
                "${{ needs.test-invalid-configurations.result }}" == "success" && \
                "${{ needs.test-edge-cases.result }}" == "success" ]]; then
            echo "ðŸŽ‰ **TODAS LAS PRUEBAS PASARON**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **ALGUNAS PRUEBAS FALLARON - REVISAR LOGS**" >> $GITHUB_STEP_SUMMARY
          fi